# Definición de Tablas y Campos (Modelo Físico) - VERSIÓN INICIAL SIMPLIFICADA

> **Integración con Supabase Auth**: La tabla `usuario` complementa Supabase Auth almacenando información específica del negocio, mientras que Supabase Auth maneja autenticación, sesiones y datos básicos del usuario. La relación se establece mediante `id_supabase` que corresponde al `auth.users.id` de Supabase.

> **Nota**: Los datos de cliente, vehículo, distribuidores y proveedor pueden tener información referenciada desde la base de datos externa (DB_DATA). Aquí solo se almacenan los identificadores y datos mínimos necesarios para la operación y trazabilidad.

---

## 1. proveedor
- id_proveedor (PK, serial)
- tipo_documento (varchar) # RUC/DNI - Ver cat_tipos_documento
- numero_documento (varchar, UNIQUE)
- razon_social (varchar) # Nombre comercial o razón social
- nombre (varchar) # Nombre de contacto o persona natural
- direccion (varchar)
- telefono (varchar)
- email (varchar)
- id_externo_db_data (varchar) # Referencia a DB_DATA externa
- estado (varchar) # Ver cat_estados_entidad: activo/inactivo/suspendido/etc.
- fecha_creacion (timestamp)
- fecha_actualizacion (timestamp)
- usuario_creacion (FK a usuario)
- usuario_actualizacion (FK a usuario)

## 2. distribuidor
- id_distribuidor (PK, serial)
- id_proveedor (FK a proveedor)
- nombre (varchar)
- telefono (varchar)
- email (varchar)
- id_externo_db_data (varchar) # Referencia a DB_DATA externa
- estado (varchar) # Ver cat_estados_entidad: activo/inactivo/suspendido/etc.
- fecha_creacion (timestamp)
- fecha_actualizacion (timestamp)
- usuario_creacion (FK a usuario)
- usuario_actualizacion (FK a usuario)

## 3. punto_venta
- id_punto_venta (PK, serial)
- tipo_documento (varchar) # RUC/DNI - Ver cat_tipos_documento
- numero_documento (varchar, UNIQUE)
- nombre (varchar)
- direccion (varchar)
- telefono (varchar)
- email (varchar)
- id_externo_db_data (varchar) # Referencia a DB_DATA externa
- estado (varchar) # Ver cat_estados_entidad: activo/inactivo/suspendido/etc.
- fecha_creacion (timestamp)
- fecha_actualizacion (timestamp)
- usuario_creacion (FK a usuario)
- usuario_actualizacion (FK a usuario)

## 4. afiliacion_pv_proveedor
- id_afiliacion (PK, serial)
- id_proveedor (FK a proveedor)
- id_distribuidor (FK a distribuidor)
- id_punto_venta (FK a punto_venta)
- estado (varchar) # Ver cat_estados_afiliacion: pendiente/verificado/activo/suspendido/rechazado/cancelado
- fecha_verificacion (timestamp)
- usuario_verificador (FK a usuario)
- fecha_creacion (timestamp)
- fecha_actualizacion (timestamp)
- usuario_creacion (FK a usuario)
- usuario_actualizacion (FK a usuario)

## 5. zona
- id_zona (PK, serial)
- id_proveedor (FK a proveedor)
- nombre (varchar)
- descripcion (text)
- estado (varchar) # Ver cat_estados_entidad: activo/inactivo
- fecha_creacion (timestamp)
- fecha_actualizacion (timestamp)
- usuario_creacion (FK a usuario)
- usuario_actualizacion (FK a usuario)

## 6. zona_punto_venta
- id_zona_pv (PK, serial)
- id_zona (FK a zona)
- id_punto_venta (FK a punto_venta)
- fecha_asignacion (timestamp)
- estado (varchar) # Ver cat_estados_entidad: activo/inactivo
- fecha_creacion (timestamp)
- fecha_actualizacion (timestamp)
- usuario_creacion (FK a usuario)
- usuario_actualizacion (FK a usuario)

## 7. certificado
- id_certificado (PK, serial)
- id_proveedor (FK a proveedor)
- numero_serie (varchar, UNIQUE)
- categoria (varchar) # Ver cat_categorias_certificado: publico/taxi/urbano/turismo/escolar/etc.
- tipo_certificado (varchar) # Ver cat_tipos_certificado: fisico/virtual
- foto_url (varchar) # URL de la imagen del certificado
- datos_vehiculo_externo (varchar) # ID externo a DB_DATA para datos del vehículo
- estado (varchar) # Ver cat_estados_certificado: creado/asignado/vendido/suspendido/de_baja
- fecha_registro (timestamp)
- fecha_asignacion (timestamp) # Cuando se asigna a un PV
- fecha_venta (timestamp) # Cuando se vende al cliente final
- fecha_actualizacion (timestamp)
- usuario_creacion (FK a usuario)
- usuario_actualizacion (FK a usuario)

## 8. venta
- id_venta (PK, serial)
- id_punto_venta (FK a punto_venta)
- fecha (timestamp)
- precio_total (decimal) # Suma total de precios de todos los certificados vendidos
- id_cliente_externo (varchar) # ID externo a DB_DATA del cliente
- observaciones (text)
- estado (varchar) # activa/anulada
- fecha_creacion (timestamp)
- fecha_actualizacion (timestamp)
- usuario_creacion (FK a usuario)
- usuario_actualizacion (FK a usuario)

## 9. venta_certificado
- id_venta_cert (PK, serial)
- id_venta (FK a venta)
- id_certificado (FK a certificado)
- precio_venta (decimal) # Precio al que se vendió al cliente final
- monto_fijo_proveedor (decimal) # Monto que recibe el proveedor
- descuento_aplicado (decimal) # Descuento aplicado al monto fijo del proveedor
- ganancia_pv (decimal) # Ganancia del punto de venta (precio_venta - monto_fijo_proveedor + descuento)
- estado (varchar) # vendido/anulado
- fecha_creacion (timestamp)
- fecha_actualizacion (timestamp)

## 10. descuento_pv
- id_descuento (PK, serial)
- id_proveedor (FK a proveedor)
- id_punto_venta (FK a punto_venta)
- tipo_descuento (varchar) # Ver cat_tipos_descuento: porcentaje/monto_fijo/promocional/volumen
- porcentaje (decimal) # Porcentaje de descuento (si aplica)
- monto_fijo (decimal) # Monto fijo de descuento (si aplica)
- fecha_inicio (date)
- fecha_fin (date)
- estado (varchar) # Ver cat_estados_entidad: activo/inactivo
- fecha_creacion (timestamp)
- fecha_actualizacion (timestamp)
- usuario_creacion (FK a usuario)
- usuario_actualizacion (FK a usuario)

## 11. deuda
- id_deuda (PK, serial)
- id_venta (FK a venta)
- id_punto_venta (FK a punto_venta)
- id_proveedor (FK a proveedor)
- monto_original (decimal) # Monto inicial de la deuda
- monto_pendiente (decimal) # Monto que queda por pagar
- fecha_vencimiento (date) # Fecha límite de pago
- estado (varchar) # Ver cat_estados_deuda: pendiente/amortizando/pagado/vencido
- mora_acumulada (decimal) # Mora calculada por atraso
- fecha_creacion (timestamp)
- fecha_actualizacion (timestamp)
- usuario_creacion (FK a usuario)
- usuario_actualizacion (FK a usuario)


## 12. credito
- id_credito (PK, serial)
- id_punto_venta (FK a punto_venta)
- id_proveedor (FK a proveedor)
- limite_credito (int) # Máximo número de certificados que puede tener asignados simultáneamente
- stock_actual (int) # Número actual de certificados asignados
- estado (varchar) # Ver cat_estados_entidad: activo/inactivo
- fecha_creacion (timestamp)
- fecha_actualizacion (timestamp)
- usuario_creacion (FK a usuario)
- usuario_actualizacion (FK a usuario)

## 13. pago
- id_pago (PK, serial)
- id_punto_venta (FK a punto_venta)
- id_proveedor (FK a proveedor)
- monto (decimal) # Monto total del pago
- fecha (timestamp)
- modalidad (varchar) # Ver cat_tipos_pago: efectivo/transferencia_bancaria/yape/plin/etc.
- observaciones (text)
- estado (varchar) # activo/anulado
- usuario_registro (FK a usuario)
- fecha_creacion (timestamp)
- fecha_actualizacion (timestamp)

## 14. pago_deuda
- id_pago_deuda (PK, serial)
- id_pago (FK a pago)
- id_deuda (FK a deuda)
- monto_aplicado (decimal) # Monto específico aplicado a esta deuda
- fecha_aplicacion (timestamp)
- usuario_aplicacion (FK a usuario)

## 15. politica_mora
- id_politica (PK, serial)
- id_proveedor (FK a proveedor)
- tipo (varchar) # Ver cat_tipos_politica_mora: porcentaje_diario/monto_fijo_diario/porcentaje_total/monto_fijo_total
- valor (decimal) # Valor del porcentaje o monto fijo según el tipo
- dias_gracia (int) # Días sin penalización después del vencimiento
- estado (varchar) # Ver cat_estados_entidad: activo/inactivo
- fecha_creacion (timestamp)
- fecha_actualizacion (timestamp)
- usuario_creacion (FK a usuario)
- usuario_actualizacion (FK a usuario)

## 16. visita
- id_visita (PK, serial)
- id_proveedor (FK a proveedor)
- id_distribuidor (FK a distribuidor)
- id_punto_venta (FK a punto_venta)
- fecha (timestamp) # Fecha programada de la visita
- motivo (varchar) # Motivo de la visita: restock/cobros/soporte/supervisión/etc.
- estado (varchar) # Ver cat_estados_visita: programado/realizada/cancelada/vencida/reagendada
- observaciones (text)
- fecha_realizacion (timestamp) # Fecha real cuando se realizó
- usuario_programa (FK a usuario) # Quien programó la visita
- usuario_realiza (FK a usuario) # Quien realizó la visita
- fecha_creacion (timestamp)
- fecha_actualizacion (timestamp)

## 17. usuario (Complementa Supabase Auth)
- id_usuario (PK, serial)
- id_supabase (uuid, UNIQUE) # FK a auth.users.id de Supabase
- nombre_completo (varchar)
- tipo_documento (varchar: DNI/RUC/CE/etc.)
- numero_documento (varchar, UNIQUE)
- telefono (varchar)
- direccion (varchar)
- id_externo_db_data (varchar) # Referencia opcional a DB_DATA
- estado (activo/inactivo/suspendido)
- fecha_creacion (timestamp)
- fecha_actualizacion (timestamp)
- usuario_creacion (FK a usuario)
- usuario_actualizacion (FK a usuario)

> **Relación con Supabase Auth**: 
> - Supabase Auth maneja: email, password, autenticación, sesiones, verificación
> - Tabla usuario maneja: datos del negocio, documentos, información adicional
> - Un registro en `usuario` se crea cuando el usuario de Supabase se registra por primera vez en el sistema

## 18. usuario_rol (Sistema de Roles Simplificado)
- id_usuario_rol (PK, serial)
- id_usuario (FK a usuario)
- rol (varchar) # Valores: sistema_admin, proveedor_admin, proveedor_supervisor, proveedor_operador, distribuidor_admin, distribuidor_supervisor, distribuidor_operador, pv_admin, pv_supervisor, pv_operador
- tipo_entidad (varchar) # sistema/proveedor/distribuidor/punto_venta
- id_entidad (int) # FK a proveedor/distribuidor/punto_venta (NULL para roles de sistema)
- fecha_asignacion (timestamp)
- fecha_expiracion (timestamp) # NULL = sin vencimiento
- usuario_asignador (FK a usuario) # Quién asignó este rol
- activo (boolean)
- fecha_creacion (timestamp)
- fecha_actualizacion (timestamp)

> **Estructura de Roles Simplificada (10 roles total)**:
> - **Sistema**: sistema_admin (1 rol)
> - **Proveedor**: proveedor_admin, proveedor_supervisor, proveedor_operador (3 roles)
> - **Distribuidor**: distribuidor_admin, distribuidor_supervisor, distribuidor_operador (3 roles)
> - **Punto de Venta**: pv_admin, pv_supervisor, pv_operador (3 roles)

> **Delegación**: Admin puede asignar Supervisor y Operador, Supervisor puede asignar Operador

---

## Tablas de Catálogo del Sistema

### 19. cat_tipos_pago
- id_tipo_pago (PK, serial)
- codigo (varchar, UNIQUE) # efectivo, transferencia_bancaria, yape, plin, deposito_bancario, cheque
- descripcion (varchar) # "Pago en dinero físico", "Transferencia entre cuentas bancarias", etc.
- activo (boolean) # Control de habilitación/deshabilitación

### 20. cat_estados_certificado
- id_estado_certificado (PK, serial)
- codigo (varchar, UNIQUE) # creado, asignado, vendido, suspendido, de_baja
- descripcion (varchar) # "Certificado registrado sin asignar", "Asignado a punto de venta", etc.
- activo (boolean)

### 21. cat_estados_deuda
- id_estado_deuda (PK, serial)
- codigo (varchar, UNIQUE) # pendiente, amortizando, pagado, vencido
- descripcion (varchar) # "Deuda creada no pagada dentro del plazo", "Con pagos parciales", etc.
- activo (boolean)

### 22. cat_categorias_certificado
- id_categoria_certificado (PK, serial)
- codigo (varchar, UNIQUE) # publico, taxi, urbano, turismo, escolar, carga, interprovincial
- descripcion (varchar) # "Transporte público urbano", "Servicio de taxi convencional", etc.
- activo (boolean) # Los tipos "carga" e "interprovincial" inician como false (futuro)

### 23. cat_tipos_certificado
- id_tipo_certificado (PK, serial)
- codigo (varchar, UNIQUE) # fisico, virtual
- descripcion (varchar) # "Certificado físico en papel", "Certificado digital/electrónico"
- activo (boolean)

### 24. cat_estados_usuario
- id_estado_usuario (PK, serial)
- codigo (varchar, UNIQUE) # creado, activo, suspendido, inactivo, eliminado
- descripcion (varchar) # "Usuario registrado pendiente de activación", "Usuario activo en el sistema", etc.
- activo (boolean)

### 25. cat_tipos_documento
- id_tipo_documento (PK, serial)
- codigo (varchar, UNIQUE) # dni, ruc, ce, pasaporte
- descripcion (varchar) # "Documento Nacional de Identidad (Persona Natural)", "RUC (Persona Jurídica)", etc.
- activo (boolean)

### 26. cat_estados_visita
- id_estado_visita (PK, serial)
- codigo (varchar, UNIQUE) # programado, realizada, cancelada, vencida, reagendada
- descripcion (varchar) # "Visita programada pendiente", "Visita completada exitosamente", etc.
- activo (boolean)

### 27. cat_estados_entidad
- id_estado_entidad (PK, serial)
- codigo (varchar, UNIQUE) # activo, inactivo, suspendido, pendiente_verificacion, rechazado
- descripcion (varchar) # "Entidad operativa y funcional", "Entidad suspendida por incumplimientos", etc.
- activo (boolean)

### 28. cat_estados_afiliacion
- id_estado_afiliacion (PK, serial)
- codigo (varchar, UNIQUE) # pendiente, verificado, activo, suspendido, rechazado, cancelado
- descripcion (varchar) # "Afiliación solicitada pendiente de aprobación", "Afiliación aprobada y operativa", etc.
- activo (boolean)

### 29. cat_tipos_descuento
- id_tipo_descuento (PK, serial)
- codigo (varchar, UNIQUE) # porcentaje, monto_fijo, promocional, volumen
- descripcion (varchar) # "Descuento basado en porcentaje", "Descuento de cantidad fija en soles", etc.
- activo (boolean)

### 30. cat_tipos_politica_mora
- id_tipo_politica_mora (PK, serial)
- codigo (varchar, UNIQUE) # porcentaje_diario, monto_fijo_diario, porcentaje_total, monto_fijo_total
- descripcion (varchar) # "Mora calculada como porcentaje diario", "Monto fijo por día de atraso", etc.
- activo (boolean)

---

## Integración con Supabase Auth

### Arquitectura de Autenticación y Autorización

**Supabase Auth (auth.users)**:
- Maneja autenticación (login/logout)
- Almacena email y password hash
- Gestiona sesiones y tokens JWT
- Verificación de email
- Recuperación de contraseña
- Providers externos (Google, etc.)

**Tabla usuario (Nuestro sistema)**:
- Extiende información del usuario autenticado
- Almacena datos específicos del negocio
- Referencia a `auth.users.id` mediante `id_supabase`
- Información de documentos de identidad
- Estado en el sistema de negocio

**Tabla usuario_rol (Sistema de permisos)**:
- Define qué puede hacer el usuario autenticado
- Roles jerárquicos por entidad organizacional
- Control de acceso basado en roles (RBAC)

### Flujo de Registro y Autenticación

1. **Registro**: Usuario se registra en Supabase Auth (email/password)
2. **Perfil**: Se crea registro complementario en tabla `usuario` con `id_supabase`
3. **Roles**: Administrador asigna roles en `usuario_rol` según la organización
4. **Acceso**: Usuario autenticado accede según sus roles asignados

### Row Level Security (RLS)

```sql
-- Ejemplo de política RLS usando Supabase Auth
CREATE POLICY "usuarios_solo_ven_su_info" ON usuario
  FOR SELECT USING (id_supabase = auth.uid());

CREATE POLICY "admin_sistema_ve_todo" ON usuario
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM usuario_rol ur 
      JOIN usuario u ON ur.id_usuario = u.id_usuario
      WHERE u.id_supabase = auth.uid() 
      AND ur.rol = 'sistema_admin' 
      AND ur.activo = true
    )
  );
```

---

## Resumen del Modelo Físico

### Estructura Completa
- **Tablas Principales**: 18 tablas (proveedor → visita)
- **Tablas de Catálogo**: 12 tablas (cat_tipos_pago → cat_tipos_politica_mora)
- **Total**: 30 tablas

### Campos de Auditoría Estándar
Todas las tablas principales incluyen:
- `fecha_creacion` (timestamp)
- `fecha_actualizacion` (timestamp)
- `usuario_creacion` (FK a usuario)
- `usuario_actualizacion` (FK a usuario)

### Referencias a Catálogos
Los campos que referencian catálogos están documentados con comentarios:
- `estado` → Referencia a `cat_estados_*` correspondiente
- `tipo_documento` → Referencia a `cat_tipos_documento`
- `modalidad` → Referencia a `cat_tipos_pago`
- etc.

### Integración Externa
- **DB_DATA**: Referencias mediante campos `id_externo_db_data` y `datos_vehiculo_externo`
- **Supabase Auth**: Integración mediante `id_supabase` en tabla `usuario`

### Consideraciones de Diseño
- **Flexibilidad**: Uso de catálogos permite modificar valores sin cambios de esquema
- **Auditoría**: Trazabilidad completa de cambios y usuarios responsables
- **Escalabilidad**: Arquitectura preparada para roles especializados futuros
- **Integridad**: Foreign Keys claramente definidas entre todas las relaciones

> **Nota**: Este modelo físico está listo para implementación en PostgreSQL con las consideraciones de tipos de datos y restricciones necesarias para el sistema de certificados AFOCAT.
