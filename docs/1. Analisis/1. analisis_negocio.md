# Análisis del Negocio: Sistema de Venta de Certificados AFOCAT

## 1. Jerarquía y Flujo de Registro
- El sistema administra **proveedores** (personas naturales o jurídicas) de certificados.
- Cada proveedor registra distribuidores (relación 1:1).
- Los distribuidores registran puntos de venta, pero la afiliación solo es válida tras la verificación final del proveedor.
- Un punto de venta puede estar afiliado a varios proveedores, pero solo una vez por proveedor.

## 2. Certificados
- Los certificados son creados y gestionados por los proveedores.
- Cada certificado es único y contiene información relevante (foto, motor, precio, categoría, etc.).
- Los certificados se asignan a puntos de venta a través de los distribuidores, pudiendo ser asignados en bloques (especialmente en modalidad de crédito).

## 3. Zonas y Distribuidores
- Cada proveedor define sus propias zonas.
- Los distribuidores y puntos de venta pueden ser asignados a zonas, pero un punto de venta solo puede pertenecer a una zona por proveedor.
- Las zonas y su gestión son independientes entre proveedores.

## 4. Ventas, Ganancias y Descuentos
- El punto de venta realiza la venta de certificados, fijando el precio final.
- El proveedor recibe un monto fijo por cada certificado vendido, que puede ser reducido por un descuento específico asignado al punto de venta.
- El resto es ganancia del punto de venta.
- Los puntos de venta pueden visualizar sus ganancias por las ventas generadas.


## 5. Crédito (Límite de Certificados)

- Cada punto de venta tiene un **crédito**: es el máximo número de certificados que puede tener asignados simultáneamente, definido por el proveedor.
- Cuando un distribuidor asigna certificados a un punto de venta, debe respetar este límite. Ejemplo: si el crédito es 10 y el PV tiene 5 certificados en stock, solo puede recibir hasta 5 adicionales.
- El stock disponible se actualiza cada vez que el punto de venta vende un certificado (reduce stock) o recibe una nueva asignación (aumenta stock, sin exceder el límite).
- El proveedor puede modificar el crédito de cada punto de venta según su política interna.
- No existe financiamiento ni cuotas: el control es únicamente sobre la cantidad máxima de certificados en poder del punto de venta.

> Nota: El sistema solo gestiona el crédito asignado y vendido. El término "crédito" se refiere exclusivamente al límite de certificados asignables, no a financiamiento monetario.

## 6. Deudas, Pagos y Moras
- Cada venta genera una deuda del punto de venta hacia el proveedor, con un plazo de pago determinado.
- Los pagos pueden aplicarse a una o varias deudas, según lo decida el usuario.
- Si el pago no cubre una deuda completa, se registra como amortización parcial.
- Cada proveedor define su política de mora (monto fijo o porcentaje, días de gracia).
- El sistema calcula y registra moras por atraso en los pagos de deudas.

## 7. Visitas
- Los proveedores o jefes de distribución pueden programar visitas de distribuidores a puntos de venta (por restock, cobros, soporte, etc.).
- Las visitas tienen fecha, motivo, estado y pueden ser gestionadas y monitoreadas.

## 8. Identificación y Usuarios
- Proveedores: identificados por tipo y número de documento (RUC, DNI, etc.).
- Puntos de venta: pueden ser RUC o DNI.
- Usuarios autenticados por Supabase (ID externo), con posibilidad de múltiples roles y afiliaciones.
- Al registrar un punto de venta, solo se crea una credencial la primera vez; nuevas afiliaciones solo habilitan la relación con el proveedor.

## 9. Integración Externa
- Los datos de clientes y vehículos se almacenan en otra base de datos; solo se requiere referencia (ID externo) en las ventas o certificados.


## 10. Eliminación de cuotas y financiamiento
- El sistema no contempla cuotas ni financiamiento. Todas las deudas generadas por ventas deben ser pagadas según el plazo definido por el proveedor.
- Se mantiene la trazabilidad de pagos y amortizaciones parciales sobre cada deuda.
- **Deuda:** Se genera por cada venta que el PV debe rendir al proveedor. Puede ser pagada al contado o mediante amortizaciones parciales, pero no se fracciona en cuotas.
- **Pagos:** Pueden aplicarse a deudas completas o parciales. El sistema permite pagos parciales y totales, manteniendo la trazabilidad de todos los movimientos asociados a cada deuda.

## 11. Relación de usuarios (credenciales) con entidades
- Los usuarios (credenciales) no están relacionados directamente con proveedor, distribuidor o punto de venta mediante un campo FK en esas tablas.
- La relación se gestiona a través de la tabla `usuario_rol`, que vincula cada usuario con uno o varios roles y entidades (proveedor, distribuidor, punto de venta, etc.).
- Esto permite que un usuario tenga múltiples roles y pertenezca a varias entidades, y que una entidad tenga varios usuarios asociados.
- Ejemplo: Un usuario puede ser operador de un punto de venta y, a la vez, administrador de un proveedor, todo gestionado desde `usuario_rol`.
- Para saber los usuarios de una entidad, se consulta `usuario_rol` filtrando por el rol y el id_entidad correspondiente.
- Para saber a qué entidades tiene acceso un usuario, se consulta `usuario_rol` filtrando por el id_usuario.

> Este modelo permite máxima flexibilidad y escalabilidad en la gestión de credenciales y permisos.

## 12. Sistema de Roles y Permisos Jerárquico
- El sistema implementa una **jerarquía estricta** de roles: Sistema → Proveedor → Distribuidor → Punto de Venta.
- Cada nivel tiene **autonomía para administrar sus subordinados** dentro de su contexto organizacional.
- Los **permisos son delegables**: los superiores pueden conceder y revocar roles a sus subordinados.
- Cada rol está **limitado al ámbito** de su organización específica, garantizando la separación entre entidades.

### 12.1. Roles de Sistema (Nivel Global) - **VERSIÓN INICIAL SIMPLIFICADA**
- **Administrador Sistema**: Control total del sistema, gestión de proveedores y configuración global.

> **Lógica de Negocio**: El administrador del sistema crea y gestiona proveedores. El sistema tiene flexibilidad completa para ejecutar cualquier operación cuando sea necesario para manejo de errores o casos especiales.

### 12.2. Roles de Proveedor (Contexto: ID del Proveedor) - **VERSIÓN INICIAL SIMPLIFICADA**
- **Administrador/Dueño**: Control total sobre su organización, gestión de distribuidores y políticas.
- **Supervisor**: Supervisión de operaciones, aprobación de afiliaciones y gestión de red.
- **Operador**: Operaciones diarias, gestión básica de distribuidores y reportes.

> **Permisos clave**: Pueden crear/gestionar distribuidores de su organización, aprobar afiliaciones de puntos de venta, gestionar certificados y zonas, y conceder/revocar roles dentro de su red.

### 12.3. Roles de Distribuidor (Contexto: ID del Distribuidor) - **VERSIÓN INICIAL SIMPLIFICADA**
- **Administrador/Dueño**: Control total del distribuidor, gestión de puntos de venta.
- **Supervisor**: Supervisión de puntos de venta en su área, aprobaciones.
- **Operador**: Operaciones diarias, gestión de inventario y ventas.

> **Permisos clave**: Pueden registrar puntos de venta (pendientes de aprobación del proveedor), asignar certificados respetando límites de crédito, gestionar visitas y cobros.

### 12.4. Roles de Punto de Venta (Contexto: ID del Punto de Venta) - **VERSIÓN INICIAL SIMPLIFICADA**
- **Administrador/Dueño**: Control total del punto de venta, configuración y personal.
- **Supervisor**: Supervisión de ventas y operaciones diarias.
- **Operador**: Emisión de certificados, ventas y atención al cliente.

> **Permisos clave**: Pueden registrar ventas de certificados, consultar stock y ganancias, registrar pagos de deudas.

### 12.5. Delegación de Permisos - **VERSIÓN INICIAL SIMPLIFICADA**
- **Administrador/Dueño**: Puede conceder roles de Supervisor y Operador dentro de su contexto organizacional.
- **Supervisor**: Puede conceder rol de Operador dentro de su contexto organizacional.
- **Operador**: No puede conceder roles.
- Se mantiene **trazabilidad básica** de quién concedió cada rol y cuándo.

### 12.6. Restricciones por Nivel - **VERSIÓN INICIAL SIMPLIFICADA**

#### Lógica de Negocio Normal
- **Proveedor**: Crea distribuidores, NO accede a otros proveedores.
- **Distribuidor**: Crea puntos de venta (aprobación del proveedor), NO accede a otros distribuidores.
- **Punto de Venta**: NO asigna certificados (solo distribuidor/proveedor), NO accede a otros puntos de venta.

#### Flexibilidad del Sistema
- **Sistema**: Puede ejecutar cualquier operación necesaria para manejo de errores, migración de datos u operaciones administrativas especiales.

### 12.7. Escalabilidad Futura del Sistema de Roles
- **Estructura base**: Administrador/Dueño → Supervisor → Operador permite agregar roles especializados posteriormente.
- **Roles futuros**: Finanzas, Auditor, Comercial, Soporte, etc. pueden añadirse sin cambiar la arquitectura base.
- **Contexto Multi-Organizacional**: Un punto de venta puede estar afiliado a múltiples proveedores con roles independientes para cada afiliación.

> **Implementación Práctica**: Para el lanzamiento inicial, 3 roles por nivel organizacional proporcionan funcionalidad completa manteniendo simplicidad. La escalabilidad está garantizada por la arquitectura diseñada.

## 13. Catálogos y Tipos de Datos del Sistema

### 13.1. Tipos de Pago
- **efectivo**: Pago en dinero físico
- **transferencia_bancaria**: Transferencia entre cuentas bancarias
- **yape**: Aplicación de pagos móviles Yape
- **plin**: Aplicación de pagos móviles Plin
- **deposito_bancario**: Depósito directo en cuenta bancaria
- **cheque**: Pago mediante cheque (futuro)

### 13.2. Estados de Certificado
- **creado**: Certificado registrado en el sistema, sin asignar
- **asignado**: Asignado a un punto de venta específico
- **vendido**: Vendido a un cliente final
- **suspendido**: Temporalmente inhabilitado
- **de_baja**: Dado de baja permanentemente (anulado/vencido)

### 13.3. Estados de Deuda
- **pendiente**: Deuda creada, no pagada, dentro del plazo
- **amortizando**: Deuda con pagos parciales aplicados
- **pagado**: Deuda totalmente pagada
- **vencido**: Deuda que superó la fecha de vencimiento sin pagar

### 13.4. Categorías de Certificado (Servicio)
- **publico**: Transporte público urbano
- **taxi**: Servicio de taxi convencional
- **urbano**: Transporte urbano general
- **turismo**: Transporte turístico
- **escolar**: Transporte escolar especializado
- **carga**: Transporte de carga (futuro)
- **interprovincial**: Transporte interprovincial (futuro)

### 13.5. Tipo de Certificado
- **fisico**: Certificado físico en papel
- **virtual**: Certificado digital/electrónico

### 13.6. Estados de Usuario/Acceso
- **creado**: Usuario registrado, pendiente de activación
- **activo**: Usuario activo en el sistema
- **suspendido**: Usuario temporalmente suspendido
- **inactivo**: Usuario inactivo (no suspendido, pero sin usar)
- **eliminado**: Usuario dado de baja permanentemente

### 13.7. Tipos de Documento de Identidad
- **dni**: Documento Nacional de Identidad (Persona Natural)
- **ruc**: Registro Único de Contribuyentes (Persona Jurídica)
- **ce**: Carné de Extranjería
- **pasaporte**: Pasaporte (casos especiales)

### 13.8. Estados de Visita
- **programado**: Visita programada, pendiente de realizar
- **realizada**: Visita completada exitosamente
- **cancelada**: Visita cancelada antes de realizarse
- **vencida**: Visita no realizada en fecha programada
- **reagendada**: Visita reprogramada para nueva fecha

### 13.9. Estados de Entidades del Sistema
- **activo**: Entidad operativa y funcional
- **inactivo**: Entidad temporalmente no operativa
- **suspendido**: Entidad suspendida por incumplimientos
- **pendiente_verificacion**: Entidad registrada, pendiente de aprobación
- **rechazado**: Entidad rechazada en proceso de verificación

### 13.10. Estados de Afiliación
- **pendiente**: Afiliación solicitada, pendiente de aprobación
- **verificado**: Afiliación verificada por el proveedor
- **activo**: Afiliación aprobada y operativa
- **suspendido**: Afiliación temporalmente suspendida
- **rechazado**: Afiliación rechazada
- **cancelado**: Afiliación cancelada por las partes

### 13.11. Tipos de Descuento
- **porcentaje**: Descuento basado en porcentaje del monto fijo
- **monto_fijo**: Descuento de cantidad fija en soles
- **promocional**: Descuento promocional temporal
- **volumen**: Descuento por volumen de ventas

### 13.12. Tipos de Política de Mora
- **porcentaje_diario**: Mora calculada como porcentaje diario
- **monto_fijo_diario**: Mora de monto fijo por día de atraso
- **porcentaje_total**: Porcentaje único sobre el monto total
- **monto_fijo_total**: Monto fijo único independiente del tiempo

> **Implementación**: Estos catálogos pueden implementarse como ENUMs en PostgreSQL o como tablas de referencia según la necesidad de extensibilidad futura.
