# Bosquejo de Base de Datos - VERSIÓN INICIAL SIMPLIFICADA
## (Resumen de Tablas y Relaciones con Sistema de Roles Jerárquico Básico)

## Tablas Principales

### 1. proveedor
- id_proveedor (PK)
- tipo_documento (RUC/DNI)
- numero_documento
- razon_social
- direccion
- contacto

### 2. distribuidor
- id_distribuidor (PK)
- id_proveedor (FK)
- nombre
- contacto

### 3. punto_venta
- id_punto_venta (PK)
- tipo_documento (RUC/DNI)
- numero_documento
- nombre
- direccion
- contacto

### 4. afiliacion_pv_proveedor
- id_afiliacion (PK)
- id_proveedor (FK)
- id_distribuidor (FK)
- id_punto_venta (FK)
- estado (pendiente/verificado/activo)
- fecha_verificacion
- usuario_verificador

### 5. zona
- id_zona (PK)
- id_proveedor (FK)
- nombre
- descripcion

### 6. zona_punto_venta
- id_zona_pv (PK)
- id_zona (FK)
- id_punto_venta (FK)
- fecha_asignacion

### 7. certificado
- id_certificado (PK)
- id_proveedor (FK)
- numero_serie
- categoria
- foto
- datos_vehiculo
- estado (disponible/asignado/vendido)

### 8. venta
- id_venta (PK)
- id_punto_venta (FK)
- fecha
- precio_total
- id_cliente_externo

### 9. venta_certificado
- id_venta_cert (PK)
- id_venta (FK)
- id_certificado (FK)
- precio_venta
- monto_fijo_proveedor
- descuento_aplicado
- ganancia_pv

### 10. descuento_pv
- id_descuento (PK)
- id_proveedor (FK)
- id_punto_venta (FK)
- porcentaje
- monto_fijo
- fecha_inicio
- fecha_fin

### 11. deuda
- id_deuda (PK)
- id_venta (FK)
- id_punto_venta (FK)
- id_proveedor (FK)
- monto_original
- monto_pendiente
- fecha_vencimiento
- estado (pendiente/amortizado/pagado/vencido)
- mora_acumulada



### 12. credito
- id_credito (PK)
- id_punto_venta (FK)
- id_proveedor (FK)
- limite_credito
- stock_actual

### 13. pago
- id_pago (PK)
- id_punto_venta (FK)
- id_proveedor (FK)
- monto
- fecha
- modalidad
- observaciones

### 14. pago_deuda
- id_pago_deuda (PK)
- id_pago (FK)
- id_deuda (FK)
- monto_aplicado

### 15. politica_mora
- id_politica (PK)
- id_proveedor (FK)
- tipo (fijo/porcentaje)
- valor
- dias_gracia

### 16. visita
- id_visita (PK)
- id_proveedor (FK)
- id_distribuidor (FK)
- id_punto_venta (FK)
- fecha
- motivo
- estado (pendiente/realizada/vencida)
- observaciones

### 17. usuario
- id_usuario (PK)
- id_supabase
- nombre
- tipo_documento
- numero_documento

### 18. usuario_rol - **VERSIÓN INICIAL SIMPLIFICADA**
- id_usuario_rol (PK)
- id_usuario (FK)
- rol (sistema_admin, proveedor_admin, proveedor_supervisor, proveedor_operador, distribuidor_admin, distribuidor_supervisor, distribuidor_operador, pv_admin, pv_supervisor, pv_operador)
- id_entidad (FK a proveedor/distribuidor/punto_venta, NULL para roles de sistema)
- tipo_entidad (sistema/proveedor/distribuidor/punto_venta)
- fecha_asignacion
- usuario_asignador (FK a usuario)
- activo (boolean)

---

# Sistema de Roles Simplificado

## Estructura de Roles por Nivel
- **Sistema**: 1 rol (Administrador Sistema)
- **Proveedor**: 3 roles (Administrador/Dueño, Supervisor, Operador)
- **Distribuidor**: 3 roles (Administrador/Dueño, Supervisor, Operador)  
- **Punto de Venta**: 3 roles (Administrador/Dueño, Supervisor, Operador)

## Delegación de Permisos
- **Administrador/Dueño**: Puede asignar roles Supervisor y Operador
- **Supervisor**: Puede asignar rol Operador
- **Operador**: No puede asignar roles

## Escalabilidad Futura
- La estructura permite agregar roles especializados (Finanzas, Auditor, Comercial) sin cambiar la arquitectura base
- Contexto multi-organizacional: Un usuario puede tener roles en múltiples entidades

---

## Tablas de Catálogo del Sistema

### 19. cat_tipos_pago
- id_tipo_pago (PK, serial)
- codigo (varchar, UNIQUE)
- descripcion (varchar)
- activo (boolean)

### 20. cat_estados_certificado
- id_estado_certificado (PK, serial)
- codigo (varchar, UNIQUE)
- descripcion (varchar)
- activo (boolean)

### 21. cat_estados_deuda
- id_estado_deuda (PK, serial)
- codigo (varchar, UNIQUE)
- descripcion (varchar)
- activo (boolean)

### 22. cat_categorias_certificado
- id_categoria_certificado (PK, serial)
- codigo (varchar, UNIQUE)
- descripcion (varchar)
- activo (boolean)

### 23. cat_tipos_certificado
- id_tipo_certificado (PK, serial)
- codigo (varchar, UNIQUE)
- descripcion (varchar)
- activo (boolean)

### 24. cat_estados_usuario
- id_estado_usuario (PK, serial)
- codigo (varchar, UNIQUE)
- descripcion (varchar)
- activo (boolean)

### 25. cat_tipos_documento
- id_tipo_documento (PK, serial)
- codigo (varchar, UNIQUE)
- descripcion (varchar)
- activo (boolean)

### 26. cat_estados_visita
- id_estado_visita (PK, serial)
- codigo (varchar, UNIQUE)
- descripcion (varchar)
- activo (boolean)

### 27. cat_estados_entidad
- id_estado_entidad (PK, serial)
- codigo (varchar, UNIQUE)
- descripcion (varchar)
- activo (boolean)

### 28. cat_estados_afiliacion
- id_estado_afiliacion (PK, serial)
- codigo (varchar, UNIQUE)
- descripcion (varchar)
- activo (boolean)

### 29. cat_tipos_descuento
- id_tipo_descuento (PK, serial)
- codigo (varchar, UNIQUE)
- descripcion (varchar)
- activo (boolean)

### 30. cat_tipos_politica_mora
- id_tipo_politica_mora (PK, serial)
- codigo (varchar, UNIQUE)
- descripcion (varchar)
- activo (boolean)

> **Ventajas de las tablas de catálogo**:
> - Flexibilidad para agregar/modificar valores sin cambios de esquema
> - Control de activación/desactivación de opciones
> - Facilita reportes y consultas
> - Permite descripción completa de cada valor
> - Escalabilidad para agregar metadatos adicionales

---

# Procesos del Negocio y Tablas Involucradas

## Registro y Gestión de Entidades
- proveedor, distribuidor, punto_venta, afiliacion_pv_proveedor, usuario, usuario_rol, cat_estados_entidad, cat_estados_afiliacion

## Gestión de Catálogos del Sistema
- Todas las tablas cat_* para valores predefinidos del sistema

## Gestión de Zonas
- zona, zona_punto_venta, proveedor, punto_venta

## Gestión de Certificados
- certificado, proveedor, punto_venta, cat_estados_certificado, cat_categorias_certificado, cat_tipos_certificado

## Ventas y Ganancias
- venta, venta_certificado, punto_venta, proveedor, descuento_pv, cat_tipos_descuento

## Crédito y Stock
- credito, certificado (control de límites de certificados asignados)

## Deudas, Pagos y Moras
- deuda, pago, pago_deuda, politica_mora, proveedor, punto_venta, cat_estados_deuda, cat_tipos_pago, cat_tipos_politica_mora

## Visitas
- visita, proveedor, distribuidor, punto_venta, cat_estados_visita

## Integración Externa
- venta (id_cliente_externo), certificado (datos_vehiculo)

---

# Ejemplos de Flujos para Procesos Esenciales

## 1. Crédito (Límite de Certificados)
1. El proveedor define el crédito máximo para cada punto de venta (`credito`).
2. El distribuidor asigna certificados respetando el límite de crédito disponible.
3. El stock se actualiza con ventas (reduce) y asignaciones (aumenta).
4. El proveedor puede modificar el crédito según su política.

## 2. Registro de Punto de Venta
1. El distribuidor registra un nuevo punto de venta (`punto_venta`).
2. Se crea la afiliación con estado 'pendiente' (`afiliacion_pv_proveedor`).
3. El proveedor revisa y cambia el estado a 'activo'.

## 3. Venta de Certificados
1. El PV selecciona certificados disponibles y realiza la venta (`venta`).
2. Se asocian los certificados a la venta (`venta_certificado`).
3. Se calcula monto fijo para proveedor, descuentos y ganancia del PV.
4. Los certificados cambian su estado a 'vendido'.

## 4. Pagos de Recaudaciones
1. Cada venta genera una deuda (`deuda`).
2. El PV realiza pagos (`pago`) que se asocian a deudas (`pago_deuda`).
3. El sistema actualiza el estado de la deuda según el pago (completo/parcial).
4. Se calcula mora si hay atraso según `politica_mora`.

## 5. Gestión de Roles - **VERSIÓN INICIAL SIMPLIFICADA**
1. El administrador del sistema crea proveedores y asigna `proveedor_admin`.
2. Los administradores pueden asignar roles `supervisor` y `operador` en su nivel.
3. Cada asignación registra fecha, usuario asignador y mantiene trazabilidad.

---

> Este bosquejo refleja el modelo simplificado actualizado, con sistema de roles jerárquico básico (10 roles total), deuda por venta, trazabilidad por certificado a través de `venta_certificado`, flexibilidad para pagos parciales y amortizaciones, sin cuotas ni financiamiento, y escalabilidad garantizada para roles especializados futuros.
