# Flujos de Procesos y Lógica del Sistema MultiSoat

> **Estrategia de Usuarios**: Registro de entidades + invitación por email. Se aprovechan los campos de auditoría existentes sin necesidad de tablas adicionales.

---

## 1. Registro de Empresa (Proveedor) + Invitación de Usuario
- **Tablas:** proveedor, usuario, usuario_rol
- **Campos clave:** tipo_documento, numero_documento, email_administrador, usuario_creacion, fecha_creacion
- **Flujo:**
  1. **Admin Sistema** registra el proveedor con datos empresariales
  2. Se proporciona email del representante legal/administrador
  3. **Sistema crea registro** en `proveedor` (estado: pendiente_usuario)
  4. **Sistema envía invitación automática** al email proporcionado con link personalizado
  5. **Usuario hace clic** en link y completa registro en Supabase Auth (email + contraseña)
  6. **Sistema detecta registro** y vincula automáticamente `id_supabase` con proveedor
  7. **Se crea registro** en `usuario` con `id_supabase` obtenido
  8. **Se asigna rol** 'proveedor_admin' automáticamente en `usuario_rol`
  9. **Estado del proveedor** cambia a 'activo'
  10. **Usuario puede operar** el sistema con permisos completos

## 2. Registro de Distribuidores + Invitación
- **Tablas:** distribuidor, usuario, usuario_rol
- **Campos clave:** id_proveedor, nombre, email_administrador, usuario_creacion
- **Flujo:**
  1. **Admin/Supervisor del proveedor** registra distribuidor
  2. Proporciona email del administrador del distribuidor
  3. **Sistema crea registro** en `distribuidor` (estado: pendiente_usuario)
  4. **Sistema envía invitación** con rol pre-asignado 'distribuidor_admin'
  5. **Usuario acepta invitación** y se vincula automáticamente
  6. **Distribuidor queda activo** y operativo
  7. **Trazabilidad**: `usuario_creacion` indica quién del proveedor lo registró

## 3. Registro de Punto de Venta + Afiliación + Invitación
- **Tablas:** punto_venta, afiliacion_pv_proveedor
- **Campos:**
  - punto_venta: tipo_documento, numero_documento, id_externo_db_data, fecha_creacion, usuario_creacion, estado, email_contacto
  - afiliacion_pv_proveedor: id_proveedor, id_distribuidor, id_punto_venta, estado, fecha_creacion, usuario_creacion
- **Flujo:**
  1. **Distribuidor registra punto de venta** con datos básicos y email
  2. **Sistema crea registro** en `punto_venta` (estado: pendiente_usuario)
  3. **Distribuidor crea afiliación** con proveedor (estado: pendiente_aprobacion)
  4. **Proveedor aprueba afiliación** (estado: activo)
  5. **Sistema envía invitación** automática al punto de venta con rol 'punto_venta_operador'
  6. **Usuario del PV acepta invitación** y se vincula automáticamente
  7. **Punto de venta queda operativo** con acceso al sistema
  8. **Trazabilidad**: `usuario_creacion` indica quién del distribuidor lo registró

## 4. Registro de Certificados (Inventario)
- **Tabla:** certificado
- **Campos:** id_proveedor, numero_serie, categoria, estado, fecha_registro, usuario_creacion
- **Flujo:**
  1. **Admin/Supervisor del proveedor** registra lotes de certificados
  2. **Sistema crea registros** con estado 'disponible'
  3. **Trazabilidad**: `usuario_creacion` indica quién registró el lote
  4. **Certificados quedan listos** para asignación a distribuidores

## 5. Asignación de Certificados y Aprobación
- **Tabla:** asignacion_certificado
- **Campos:** id_certificado, id_distribuidor, id_punto_venta, fecha_asignacion, usuario_asignacion, estado
- **Flujo:**
  1. **Proveedor asigna certificados** a distribuidor específico
  2. **Estado del certificado** cambia a 'asignado_distribuidor'
  3. **Distribuidor puede reasignar** a puntos de venta bajo su gestión
  4. **Estado cambia** a 'asignado_punto_venta'
  5. **Punto de venta** puede vender el certificado
  6. **Trazabilidad completa** desde proveedor hasta venta final

## 6. Proceso de Venta de Certificado
- **Tabla:** venta_certificado
- **Campos:** id_certificado, id_punto_venta, fecha_venta, usuario_venta, datos_cliente, estado
- **Flujo:**
  1. **Punto de venta realiza venta** con datos del cliente
  2. **Estado del certificado** cambia a 'vendido'
  3. **Se registra toda la información** del cliente final
  4. **Sistema genera** comprobantes y notificaciones
  5. **Trazabilidad**: cadena completa proveedor → distribuidor → punto venta → cliente

## 7. Auditoría y Reportes
- **Campos de auditoría en todas las tablas:**
  - fecha_creacion, usuario_creacion
  - fecha_modificacion, usuario_modificacion
- **Flujo:**
  1. **Todos los cambios** quedan registrados automáticamente
  2. **Reportes por nivel** de organización disponibles
  3. **Trazabilidad completa** de toda la cadena de valor
  4. **Historial de cambios** para auditorías

## 8. Gestión de Roles y Permisos
- **Tablas:** usuario_rol, rol, permiso, rol_permiso
- **Flujo de asignación de roles:**
  1. **Durante la invitación** se pre-asigna el rol correspondiente
  2. **Al aceptar invitación** el rol queda activo automáticamente
  3. **Admin de cada nivel** puede gestionar roles de su nivel inferior
  4. **Sistema garantiza** que solo se asignen roles válidos según jerarquía

### Jerarquía de roles:
- **sistema_admin**: Acceso total al sistema
- **proveedor_admin**: Gestiona todo su proveedor + distribuidores + puntos venta
- **proveedor_supervisor**: Supervisión operativa del proveedor
- **proveedor_operador**: Operaciones básicas del proveedor
- **distribuidor_admin**: Gestiona su distribuidor + puntos venta afiliados
- **distribuidor_supervisor**: Supervisión operativa del distribuidor
- **distribuidor_operador**: Operaciones básicas del distribuidor
- **punto_venta_admin**: Gestiona operaciones del punto de venta
- **punto_venta_supervisor**: Supervisión de ventas
- **punto_venta_operador**: Ventas y operaciones básicas

## 9. Estados y Transiciones
### Estados de certificados:
- **disponible** → **asignado_distribuidor** → **asignado_punto_venta** → **vendido**

### Estados de entidades:
- **pendiente_usuario** → **activo** → **inactivo** → **suspendido**

### Estados de afiliaciones:
- **pendiente_aprobacion** → **activo** → **inactivo** → **rechazado**

## 10. Notificaciones Automáticas
- **Invitaciones de registro**: Email automático con link de activación
- **Aprobaciones de afiliación**: Notificación a todas las partes
- **Asignaciones de certificados**: Confirmación al distribuidor/punto venta
- **Ventas realizadas**: Confirmación al cliente y reporte a la cadena
- **Cambios de estado**: Notificaciones según el rol y nivel de acceso

## 11. Consideraciones Técnicas de Implementación

### Integración con Supabase Auth:
- **Email obligatorio**: Todos los usuarios requieren email válido para registro
- **Usuario dual**: Registro en `auth.users` (Supabase) + `usuario` (negocio)
- **Sincronización**: Triggers para mantener consistencia entre tablas
- **Seguridad**: RLS (Row Level Security) basado en roles y jerarquía

### Estrategia de invitaciones:
- **Sin tablas adicionales**: Usar campos de auditoría existentes
- **Trazabilidad**: `usuario_creacion` indica quién creó cada entidad
- **Estados**: Entidades en estado 'pendiente_usuario' hasta completar registro
- **Automatización**: Envío de invitaciones inmediato tras crear entidad

### Validaciones de negocio:
- **Unicidad**: Documentos únicos por tipo en cada tabla
- **Jerarquía**: Validar que roles asignados respeten niveles organizacionales
- **Estados**: Transiciones válidas según reglas de negocio
- **Permisos**: Verificar autorización antes de cada operación

### Escalabilidad:
- **Índices**: En campos de consulta frecuente (documentos, emails, estados)
- **Particionamiento**: Considerar por proveedor si el volumen crece significativamente
- **Cacheo**: Estados y catálogos frecuentemente consultados
- **Optimización**: Consultas con JOINs optimizados para reportes

## 12. Flujos de Excepción

### Usuario no acepta invitación:
- **Tiempo límite**: 7 días para aceptar invitación
- **Reenvío**: Posibilidad de reenviar invitación
- **Cancelación**: Admin puede cancelar y crear nueva invitación
- **Limpieza**: Entidades en estado 'pendiente_usuario' pueden ser eliminadas

### Cambios en la organización:
- **Transferencias**: Mover puntos de venta entre distribuidores
- **Reasignaciones**: Cambiar certificados entre entidades
- **Desactivaciones**: Proceso controlado manteniendo trazabilidad
- **Reactivaciones**: Posibilidad de reactivar entidades inactivas

### Errores en datos:
- **Correcciones**: Solo admins pueden corregir datos básicos
- **Historial**: Mantener registro de correcciones realizadas
- **Validaciones**: Verificar integridad antes de permitir cambios
- **Rollback**: Capacidad de revertir cambios problemáticos

---

**Resumen**: Este documento define todos los flujos principales del sistema MultiSoat, enfocándose en la estrategia de invitaciones por email que aprovecha Supabase Auth, mantiene la trazabilidad mediante campos de auditoría existentes, y garantiza un registro ordenado y controlado de toda la cadena de valor desde proveedores hasta puntos de venta.
- **Tabla:** certificado
- **Campos:** id_punto_venta (en asignación), estado, fecha_asignacion, usuario_actualizacion
- **Flujo:**
  1. El distribuidor asigna certificados a un punto de venta (cambia estado a 'asignado').
  2. El proveedor aprueba la asignación si es necesario.

## 6. Venta de Certificado
- **Tablas:** venta, venta_certificado, certificado
- **Campos:**
  - venta: id_punto_venta, fecha, precio_total, id_cliente_externo, usuario_creacion
  - venta_certificado: id_venta, id_certificado, precio_venta, monto_fijo_proveedor, descuento_aplicado, ganancia_pv
  - certificado: estado, fecha_venta
- **Flujo:**
  1. El punto de venta realiza la venta, se crea el registro en venta y venta_certificado.
  2. El certificado cambia a estado 'vendido'.

## 7. Pago de Venta del Certificado
- **Tablas:** deuda, pago, pago_deuda
- **Campos:**
  - deuda: id_venta, monto_original, monto_pendiente, estado
  - pago: id_punto_venta, id_proveedor, monto, fecha, usuario_registro
  - pago_deuda: id_pago, id_deuda, monto_aplicado
- **Flujo:**
  1. Se genera la deuda por la venta.
  2. El punto de venta realiza el pago total, se asocia el pago a la deuda y se marca como pagada.

## 8. Pago en Método de Amortización
- **Tablas:** deuda, pago, pago_deuda
- **Flujo:**
  1. El punto de venta realiza un pago parcial.
  2. El pago se asocia a la deuda, se descuenta el monto pagado y la deuda queda como 'amortizado'.

## 9. Mora Generada
- **Tablas:** deuda, politica_mora
- **Campos:** fecha_vencimiento, estado, mora_acumulada
- **Flujo:**
  1. Si la deuda no se paga a tiempo, se calcula la mora según la política del proveedor y se suma a la deuda.

## 10. Pago con Mora Generada
- **Tablas:** deuda, pago, pago_deuda
- **Flujo:**
  1. El punto de venta realiza el pago incluyendo la mora.
  2. El pago se asocia a la deuda y se descuenta el monto total (incluyendo mora acumulada).

## 11. Asignación de Descuentos a un Punto de Venta y Venta del Mismo
- **Tablas:** descuento_pv, venta_certificado
- **Campos:**
  - descuento_pv: id_proveedor, id_punto_venta, porcentaje, monto_fijo, fecha_inicio, fecha_fin
  - venta_certificado: descuento_aplicado
- **Flujo:**
  1. El proveedor asigna un descuento al punto de venta.
  2. Al vender un certificado, se aplica el descuento y se registra en venta_certificado.

## 12. Creación de Usuario (Credenciales de Logueo)
- **Tablas:** usuario, usuario_rol
- **Campos:**
  - usuario: id_supabase, tipo_documento, numero_documento, email, fecha_creacion
  - usuario_rol: id_usuario, rol, id_entidad, fecha_asignacion
- **Flujo:**
  1. Se crea el usuario con su id de Supabase y datos mínimos.
  2. Se asigna el rol y la entidad correspondiente en usuario_rol.

---

> Cada proceso está alineado con el modelo físico y solo utiliza los identificadores y referencias externas necesarios, evitando duplicidad de datos personales o empresariales.
