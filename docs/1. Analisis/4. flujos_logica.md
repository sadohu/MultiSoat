# Flujos de Procesos y Tablas Involucradas (Modelo MultiSoat)

---

## 1. Registro de Empresa (Proveedor)
- **Tabla:** proveedor
- **Campos:** tipo_documento, numero_documento, id_externo_db_data, fecha_creacion, usuario_creacion, estado
- **Flujo:**
  1. Se registra el proveedor con su tipo y número de documento, y el id externo de db_data.
  2. Se almacena el usuario que realiza el registro.

## 2. Registro de Distribuidores
- **Tabla:** distribuidor
- **Campos:** id_proveedor, tipo_documento, numero_documento, id_externo_db_data, fecha_creacion, usuario_creacion, estado
- **Flujo:**
  1. Se registra el distribuidor vinculado a un proveedor, con su tipo y número de documento, y el id externo de db_data.

## 3. Registro de Punto de Venta y Activación
- **Tablas:** punto_venta, afiliacion_pv_proveedor
- **Campos:**
  - punto_venta: tipo_documento, numero_documento, id_externo_db_data, fecha_creacion, usuario_creacion, estado
  - afiliacion_pv_proveedor: id_proveedor, id_distribuidor, id_punto_venta, estado, fecha_creacion, usuario_creacion
- **Flujo:**
  1. Se registra el punto de venta.
  2. El distribuidor crea la afiliación con el proveedor (estado: pendiente).
  3. El proveedor aprueba la afiliación (estado: activo).

## 4. Registro de Certificados
- **Tabla:** certificado
- **Campos:** id_proveedor, numero_serie, categoria, estado, fecha_registro, usuario_creacion
- **Flujo:**
  1. El proveedor registra los certificados con su información básica.

## 5. Asignación de Certificados y Aprobación
- **Tabla:** certificado
- **Campos:** id_punto_venta (en asignación), estado, fecha_asignacion, usuario_actualizacion
- **Flujo:**
  1. El distribuidor asigna certificados a un punto de venta (cambia estado a 'asignado').
  2. El proveedor aprueba la asignación si es necesario.

## 6. Venta de Certificado
- **Tablas:** venta, venta_certificado, certificado
- **Campos:**
  - venta: id_punto_venta, fecha, precio_total, id_cliente_externo, usuario_creacion
  - venta_certificado: id_venta, id_certificado, precio_venta, monto_fijo_proveedor, descuento_aplicado, ganancia_pv
  - certificado: estado, fecha_venta
- **Flujo:**
  1. El punto de venta realiza la venta, se crea el registro en venta y venta_certificado.
  2. El certificado cambia a estado 'vendido'.

## 7. Pago de Venta del Certificado
- **Tablas:** deuda, pago, pago_deuda
- **Campos:**
  - deuda: id_venta, monto_original, monto_pendiente, estado
  - pago: id_punto_venta, id_proveedor, monto, fecha, usuario_registro
  - pago_deuda: id_pago, id_deuda, monto_aplicado
- **Flujo:**
  1. Se genera la deuda por la venta.
  2. El punto de venta realiza el pago total, se asocia el pago a la deuda y se marca como pagada.

## 8. Pago en Método de Amortización
- **Tablas:** deuda, pago, pago_deuda
- **Flujo:**
  1. El punto de venta realiza un pago parcial.
  2. El pago se asocia a la deuda, se descuenta el monto pagado y la deuda queda como 'amortizado'.

## 9. Mora Generada
- **Tablas:** deuda, politica_mora
- **Campos:** fecha_vencimiento, estado, mora_acumulada
- **Flujo:**
  1. Si la deuda no se paga a tiempo, se calcula la mora según la política del proveedor y se suma a la deuda.

## 10. Pago con Mora Generada
- **Tablas:** deuda, pago, pago_deuda
- **Flujo:**
  1. El punto de venta realiza el pago incluyendo la mora.
  2. El pago se asocia a la deuda y se descuenta el monto total (incluyendo mora acumulada).

## 11. Asignación de Descuentos a un Punto de Venta y Venta del Mismo
- **Tablas:** descuento_pv, venta_certificado
- **Campos:**
  - descuento_pv: id_proveedor, id_punto_venta, porcentaje, monto_fijo, fecha_inicio, fecha_fin
  - venta_certificado: descuento_aplicado
- **Flujo:**
  1. El proveedor asigna un descuento al punto de venta.
  2. Al vender un certificado, se aplica el descuento y se registra en venta_certificado.

## 12. Creación de Usuario (Credenciales de Logueo)
- **Tablas:** usuario, usuario_rol
- **Campos:**
  - usuario: id_supabase, tipo_documento, numero_documento, email, fecha_creacion
  - usuario_rol: id_usuario, rol, id_entidad, fecha_asignacion
- **Flujo:**
  1. Se crea el usuario con su id de Supabase y datos mínimos.
  2. Se asigna el rol y la entidad correspondiente en usuario_rol.

---

> Cada proceso está alineado con el modelo físico y solo utiliza los identificadores y referencias externas necesarios, evitando duplicidad de datos personales o empresariales.
